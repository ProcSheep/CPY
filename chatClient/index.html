<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI聊天界面</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: #f7f8fa;
        }

        /* 左侧边栏样式 */
        .sidebar {
            width: 300px;
            background-color: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .model-info {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .model-info .label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .model-info .value {
            font-weight: 500;
            margin-bottom: 12px;
        }

        .change-model-btn {
            width: 100%;
            padding: 10px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .change-model-btn:hover {
            background-color: #2563eb;
        }

        .history-section {
            flex: 1;
            overflow-y: auto;
        }

        .new-chat-btn {
            width: calc(100% - 20px);
            margin: 10px;
            padding: 10px;
            border: 1px dashed #d1d5db;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #4b5563;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .new-chat-btn:hover {
            background-color: #f3f4f6;
        }

        .history-title {
            font-size: 12px;
            text-transform: uppercase;
            color: #6b7280;
            padding: 8px 20px;
            font-weight: 500;
            border-top: 1px solid #e5e7eb;
        }

        .history-list {
            list-style: none;
        }

        .history-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:hover {
            background-color: #f9fafb;
        }

        .history-item.active {
            background-color: #eff6ff;
            border-left: 3px solid #3b82f6;
        }

        .history-name {
            font-size: 14px;
            color: #111827;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            margin-right: 10px;
        }

        .rename-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 4px;
        }

        .rename-btn:hover {
            color: #3b82f6;
        }

        /* 右侧聊天区域样式 */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 20px;
            max-width: 80%;
        }

        .message.user {
            margin-left: auto;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
        }

        .user .message-content {
            background-color: #3b82f6;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .ai .message-content {
            background-color: white;
            color: #111827;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 4px;
        }

        .input-area {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            background-color: white;
        }

        .chat-form {
            position: relative;
        }

        /* 保持原有样式不变，添加以下新样式, 运营与模型气泡 */
        .message-meta {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
            margin-left: 16px;
        }
        
        .ai .message-meta {
            margin-left: 16px;
        }

        .user-input {
            width: 100%;
            padding: 14px 50px 14px 16px;
            border: 1px solid #d1d5db;
            border-radius: 24px;
            resize: none;
            font-size: 16px;
            min-height: 50px;
        }

        .user-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .send-btn {
            position: absolute;
            right: 12px;
            bottom: 12px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #3b82f6;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            background-color: #2563eb;
        }

        /* 弹窗样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s linear 0.25s, opacity 0.25s;
        }

        .modal-overlay.active {
            visibility: visible;
            opacity: 1;
            transition-delay: 0s;
        }

        .modal {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            padding: 24px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #111827;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: #4b5563;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .cancel-btn {
            background-color: white;
            border: 1px solid #d1d5db;
            color: #4b5563;
        }

        .cancel-btn:hover {
            background-color: #f3f4f6;
        }

        .confirm-btn {
            background-color: #3b82f6;
            border: none;
            color: white;
        }

        .confirm-btn:hover {
            background-color: #2563eb;
        }

        /* 工具类 */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <!-- 左侧边栏 -->
    <div class="sidebar">
        <div class="model-info">
            <div class="label">当前运营商</div>
            <div id="current-provider" class="value">豆包</div>
            <div class="label">当前模型</div>
            <div id="current-model" class="value">default</div>
            <button id="change-model-btn" class="change-model-btn">
                <span>更改模型</span>
            </button>
        </div>
        
        <div class="history-section scrollbar-hide">
            <button id="new-chat-btn" class="new-chat-btn">
                <span>新对话</span>
            </button>
            <div class="history-title">历史对话</div>
            <ul id="history-list" class="history-list">
                <!-- 历史对话会动态添加 -->
            </ul>
        </div>
    </div>
    
    <!-- 右侧聊天区域 -->
    <div class="chat-area">
        <div id="chat-container" class="chat-messages scrollbar-hide">
            <!-- 欢迎消息 -->
            <div class="message ai">
                <div class="message-content">
                    你好！我是AI助手，有什么可以帮助你的吗？
                </div>
            </div>
        </div>
        
        <div class="input-area">
            <form id="chat-form" class="chat-form">
                <textarea 
                    id="user-input" 
                    class="user-input" 
                    placeholder="输入消息..."
                ></textarea>
                <button type="submit" class="send-btn">→</button>
            </form>
        </div>
    </div>
    
    <!-- 更改模型弹窗 -->
    <div id="model-modal" class="modal-overlay">
        <div class="modal">
            <h3 class="modal-title">更改运营商和模型</h3>
            <form id="model-form">
                <div class="form-group">
                    <label class="form-label" for="provider-input">运营商（可选）</label>
                    <input 
                        type="text" 
                        id="provider-input" 
                        class="form-input"
                        placeholder="输入运营商名称（可选）"
                    >
                </div>
                <div class="form-group">
                    <label class="form-label" for="model-input">模型(必选)</label>
                    <input 
                        type="text" 
                        id="model-input" 
                        class="form-input"
                        placeholder="输入模型名称（必选）"
                    >
                </div>
                <div class="modal-buttons">
                    <button type="button" id="cancel-modal" class="modal-btn cancel-btn">取消</button>
                    <button type="submit" class="modal-btn confirm-btn">确认</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 重命名弹窗 -->
    <div id="rename-modal" class="modal-overlay">
        <div class="modal">
            <h3 class="modal-title">重命名对话</h3>
            <form id="rename-form">
                <div class="form-group">
                    <label class="form-label" for="rename-input">对话名称</label>
                    <input 
                        type="text" 
                        id="rename-input" 
                        class="form-input"
                        placeholder="输入对话名称"
                    >
                    <input type="hidden" id="rename-chat-id">
                </div>
                <div class="modal-buttons">
                    <button type="button" id="cancel-rename" class="modal-btn cancel-btn">取消</button>
                    <button type="submit" class="modal-btn confirm-btn">确认</button>
                </div>
            </form>
        </div>
    </div>

    <script>

  
  // 数据管理模块
  const ChatData = {
      // 初始化本地存储
      init() {
          if (!localStorage.getItem('ai_chat_history')) {
              localStorage.setItem('ai_chat_history', JSON.stringify({}));
          }
          
          if (!localStorage.getItem('ai_current_chat_id')) {
              const firstChatId = this.createNewChat();
              localStorage.setItem('ai_current_chat_id', firstChatId);
          }
          
          if (!localStorage.getItem('ai_model_settings')) {
              localStorage.setItem('ai_model_settings', JSON.stringify({
                  provider: '',
                  model: 'mistralai/mistral-nemo'
              }));
          }
      },
      
      // 创建新对话
      createNewChat() {
          const now = new Date();
          const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
          const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
          const defaultName = `${dateStr} ${timeStr}`;
          
          const chatId = Date.now().toString();
          const history = this.getChatHistory();
          
          history[chatId] = {
              id: chatId,
              name: defaultName,
              messages: []
          };
          
          localStorage.setItem('ai_chat_history', JSON.stringify(history));
          return chatId;
      },
      
      // 获取所有对话历史
      getChatHistory() {
          return JSON.parse(localStorage.getItem('ai_chat_history') || '{}'); // 对象
      },
      
      // 获取当前对话
      getCurrentChat() {
          const chatId = localStorage.getItem('ai_current_chat_id');
          const history = this.getChatHistory();
          return history[chatId] || null;
      },
      
      // 切换对话
      switchChat(chatId) {
          localStorage.setItem('ai_current_chat_id', chatId);
      },
      
      // 添加消息到当前对话
      addMessage(content, isUser = true) {
          const chatId = localStorage.getItem('ai_current_chat_id');
          const history = this.getChatHistory();
          
          if (history[chatId]) {
              const message = {
                  id: Date.now().toString(),
                  content,
                  isUser,
                  timestamp: new Date().toISOString()
              };
              
              history[chatId].messages.push(message);
              localStorage.setItem('ai_chat_history', JSON.stringify(history));
              return message;
          }
          return null;
      },
      
      // 重命名对话
      renameChat(chatId, newName) {
          const history = this.getChatHistory();
          if (history[chatId]) {
              history[chatId].name = newName;
              localStorage.setItem('ai_chat_history', JSON.stringify(history));
              return true;
          }
          return false;
      },
      
      // 获取模型设置
      getModelSettings() {
          return JSON.parse(localStorage.getItem('ai_model_settings') || '{"provider":"","model":"mistralai/mistral-nemo"}');
      },
      
      // 保存模型设置
      saveModelSettings(provider, model) {
          localStorage.setItem('ai_model_settings', JSON.stringify({ provider, model }));
      }
  };

  // UI渲染模块
  const ChatUI = {
      // 初始化UI
      init() {
          this.chatContainer = document.getElementById('chat-container');
          this.historyList = document.getElementById('history-list');
          this.userInput = document.getElementById('user-input');
          this.chatForm = document.getElementById('chat-form');
          this.currentProviderEl = document.getElementById('current-provider');
          this.currentModelEl = document.getElementById('current-model');
          
          // 模态框元素
          this.modelModal = document.getElementById('model-modal');
          this.renameModal = document.getElementById('rename-modal');
          this.providerInput = document.getElementById('provider-input');
          this.modelInput = document.getElementById('model-input');
          this.modelForm = document.getElementById('model-form');
          this.renameInput = document.getElementById('rename-input');
          this.renameChatId = document.getElementById('rename-chat-id');
          this.renameForm = document.getElementById('rename-form');
          
          this.loadEventListeners();
          this.renderModelSettings();
          this.renderHistoryList();
          this.renderCurrentChat();
      },
      
      // 加载事件监听器
      loadEventListeners() {
          // 发送消息
          this.chatForm.addEventListener('submit', (e) => {
              e.preventDefault();
              const content = this.userInput.value.trim();
              if (content) {
                  this.sendMessage(content);
                  this.userInput.value = '';
              }
          });
          
          // 新对话
          document.getElementById('new-chat-btn').addEventListener('click', () => {
              const newChatId = ChatData.createNewChat();
              ChatData.switchChat(newChatId);
              this.renderHistoryList();
              this.clearChatContainer();
              this.addSystemMessage('你好！我是AI助手，有什么可以帮助你的吗？');
          });
          
          // 更改模型按钮
          document.getElementById('change-model-btn').addEventListener('click', () => {
              const settings = ChatData.getModelSettings();
              this.providerInput.value = settings.provider;
              this.modelInput.value = settings.model;
              this.modelModal.classList.add('active');
          });
          
          // 取消模型更改
          document.getElementById('cancel-modal').addEventListener('click', () => {
              this.modelModal.classList.remove('active');
          });
          
          // 提交模型更改
          this.modelForm.addEventListener('submit', (e) => {
              e.preventDefault();
              const provider = this.providerInput.value.trim()
              const model = this.modelInput.value.trim() || 'mistralai/mistral-nemo';
              ChatData.saveModelSettings(provider, model);
              this.renderModelSettings();
              this.modelModal.classList.remove('active');
          });
          
          // 取消重命名
          document.getElementById('cancel-rename').addEventListener('click', () => {
              this.renameModal.classList.remove('active');
          });
          
          // 提交重命名
          this.renameForm.addEventListener('submit', (e) => {
              e.preventDefault();
              const newName = this.renameInput.value.trim();
              const chatId = this.renameChatId.value;
              
              if (newName && chatId) {
                  ChatData.renameChat(chatId, newName);
                  this.renderHistoryList();
                  this.renameModal.classList.remove('active');
              }
          });

          // 回车发送消息
            // 监听输入框的回车键事件
            this.userInput.addEventListener('keydown', (e) => {
                // 当按下Enter键且没有按住Shift键时
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // 阻止默认换行行为
                    this.chatForm.dispatchEvent(new Event('submit')); // 触发表单提交
                }
            });
      },
    sendMessage(content) {
        // 添加用户消息（这部分 content 传递正确）
        const userMessage = ChatData.addMessage(content, true);
        this.addMessageToUI(userMessage);
        
        // AI回复（修正异步处理）
        this.sendMessageToOpenAI(content).then(res => {
            const aiMessage = ChatData.addMessage(res.content, false);
            this.addMessageToUI(aiMessage);
        }).catch(err => {
            console.error('请求出错:', err);
            const errorMessage = ChatData.addMessage('抱歉，获取回复失败，请重试', false);
            this.addMessageToUI(errorMessage);
        });
    },
   async sendMessageToOpenAI(content) {
    try {
            // 获取本地存储的模型设置
            const modelSettingStr = localStorage.getItem("ai_model_settings");
            const modelSetting = modelSettingStr ? JSON.parse(modelSettingStr) : {};
            // 取出provider（默认空字符串，避免undefined）
            let provider = modelSetting.provider || ""; 
            console.log('当前使用的供应商:', provider);

            // 发送请求
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: { 
                    "Authorization": "Bearer ...", // tok
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    "model": "mistralai/mistral-nemo",
                    // 只有当provider不为空时才传递provider参数（可选优化）
                    ...(provider && { 
                        "provider": { "order": [provider] } 
                    }),
                    "messages": [
                        { "role": "user", "content": content }
                    ]
                })
            });

            // 解析响应数据
            const data = await response.json();

            // 检查请求是否成功
            if (!response.ok) {
                throw new Error(`接口错误: ${data.error?.message || '未知错误'}`);
            }

            // 核心逻辑：如果原始provider为空字符串，且接口返回了provider，则更新本地存储
            if (provider === "" && data.provider) {
                // 更新modelSetting中的provider
                modelSetting.provider = data.provider;
                // 存入localStorage（覆盖原数据）
                localStorage.setItem(
                    "ai_model_settings", 
                    JSON.stringify(modelSetting)
                );
                console.log('已更新本地供应商为:', data.provider);
            }

            // 返回AI回复内容
            return data.choices[0].message;

        } catch (error) {
            console.error('OpenAI API 错误:', error);
            throw error; // 让调用方处理错误
        }
    },
      
      // 添加消息到UI
      addMessageToUI(message) {
          const messageDiv = document.createElement('div');
          messageDiv.className = `message ${message.isUser ? 'user' : 'ai'}`;
          
          const contentDiv = document.createElement('div');
          contentDiv.className = 'message-content';
          contentDiv.textContent = message.content;

          // 只在AI消息下方添加模型和运营商信息
            if (!message.isUser) {
                const settings = ChatData.getModelSettings();
                const metaDiv = document.createElement('div');
                metaDiv.className = 'message-meta';
                metaDiv.textContent = `模型: ${settings.model} | 运营商: ${settings.provider}`;
                messageDiv.appendChild(metaDiv);
            }
          
          messageDiv.appendChild(contentDiv);
          this.chatContainer.appendChild(messageDiv);
          this.scrollToBottom();
      },
      
      // 添加系统消息
      addSystemMessage(content) {
          const messageDiv = document.createElement('div');
          messageDiv.className = 'message ai';
          
          const contentDiv = document.createElement('div');
          contentDiv.className = 'message-content';
          contentDiv.textContent = content;
          
          messageDiv.appendChild(contentDiv);
          this.chatContainer.appendChild(messageDiv);
          this.scrollToBottom();
      },
      
      // 渲染当前对话
      renderCurrentChat() {
          this.clearChatContainer();
          const currentChat = ChatData.getCurrentChat();
          
          if (!currentChat || currentChat.messages.length === 0) {
              this.addSystemMessage('你好！我是AI助手，有什么可以帮助你的吗？');
              return;
          }
          
          currentChat.messages.forEach(message => {
              this.addMessageToUI(message);
          });
      },
      
      // 渲染历史列表
      renderHistoryList() {
          this.historyList.innerHTML = '';
          const history = ChatData.getChatHistory();
          const currentChatId = localStorage.getItem('ai_current_chat_id');
          
          // 将历史记录按时间倒序排列
          const sortedChats = Object.values(history).sort((a, b) => 
              b.id - a.id
          );
          
          sortedChats.forEach(chat => {
              const li = document.createElement('li');
              li.className = `history-item ${chat.id === currentChatId ? 'active' : ''}`;
              li.dataset.chatId = chat.id;
              
              const nameSpan = document.createElement('span');
              nameSpan.className = 'history-name';
              nameSpan.textContent = chat.name;
              
              const renameBtn = document.createElement('button');
              renameBtn.className = 'rename-btn';
              renameBtn.textContent = '重命名';
              renameBtn.addEventListener('click', (e) => {
                  e.stopPropagation();
                  this.renameInput.value = chat.name;
                  this.renameChatId.value = chat.id;
                  this.renameModal.classList.add('active');
              });
              
              li.appendChild(nameSpan);
              li.appendChild(renameBtn);
              
              li.addEventListener('click', () => {
                  ChatData.switchChat(chat.id);
                  this.renderHistoryList();
                  this.renderCurrentChat();
              });
              
              this.historyList.appendChild(li);
          });
      },
      
      // 渲染模型设置
      renderModelSettings() {
          const settings = ChatData.getModelSettings();
          this.currentProviderEl.textContent = settings.provider;
          this.currentModelEl.textContent = settings.model;
      },
      
      // 清空聊天容器
      clearChatContainer() {
          this.chatContainer.innerHTML = '';
      },
      
      // 滚动到底部
      scrollToBottom() {
          this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
      }
  };

  // 初始化应用
  document.addEventListener('DOMContentLoaded', () => {
      ChatData.init();
      ChatUI.init();
  });
    </script>
</body> 
</html>